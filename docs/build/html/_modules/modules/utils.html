<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>modules.utils &#8212; Trailer Finder v1.4.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=32cf698c"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for modules.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module providing utility functions for handling trailers, downloading from YouTube, and post-processing with FFMPEG.</span>

<span class="sd">This module includes classes and functions for interacting with TMDB API, downloading trailers, and performing</span>
<span class="sd">post-processing using FFMPEG.</span>

<span class="sd">Classes:</span>
<span class="sd">    - Utils: Contains utility methods for trailer handling, downloading, and processing.</span>

<span class="sd">Functions:</span>
<span class="sd">    - replace_slash_backslash: Replaces forward slashes and backward slashes with spaces.</span>
<span class="sd">    - get_title: Retrieves the title of an item from its metadata.</span>
<span class="sd">    - trailer_pull: Retrieves trailer information from TMDB API.</span>
<span class="sd">    - post_process: Performs post-processing on downloaded trailers using FFMPEG.</span>
<span class="sd">    - download_trailers: Downloads trailers from YouTube using YoutubeDL.</span>
<span class="sd">    - check_space: Checks available disk space for downloading and processing trailers.</span>
<span class="sd">    - get_new_trailers: Retrieves trailer names that do not already exist in the specified folder.</span>
<span class="sd">Example of usage:</span>

<span class="sd"># Importing Logger class and Utils module</span>
<span class="sd">from modules.logger import Logger</span>
<span class="sd">from modules.utils import Utils</span>

<span class="sd"># Initializing the logger</span>
<span class="sd">logger = Logger()</span>
<span class="sd">config = {</span>
<span class="sd">    &quot;RADARR_USE_NAME&quot;: &quot;originalTitle&quot;,</span>
<span class="sd">    &quot;TMDB_API_KEY&quot;: &quot;your_tmdb_api_key_here&quot;,</span>
<span class="sd">    # Other configurations here...</span>
<span class="sd">}</span>

<span class="sd"># Initializing an instance of Utils</span>
<span class="sd">utils = Utils(logger, config)</span>

<span class="sd"># Example usage to download trailers</span>
<span class="sd">tmdb_id = &quot;12345&quot;</span>
<span class="sd">item_type = &quot;movie&quot;</span>

<span class="sd"># Fetching trailer information from TMDB</span>
<span class="sd">trailers = utils.trailer_pull(tmdb_id, item_type)</span>

<span class="sd"># Downloading trailers from YouTube</span>
<span class="sd">item_metadata = {</span>
<span class="sd">    &quot;title&quot;: &quot;Your Movie Title&quot;,</span>
<span class="sd">    &quot;year&quot;: 2024,</span>
<span class="sd">    &quot;path&quot;: &quot;/path/to/movie&quot;,</span>
<span class="sd">    &quot;outputs_folder&quot;: &quot;/path/to/output/folder&quot;,</span>
<span class="sd">    # Other metadata here...</span>
<span class="sd">}</span>
<span class="sd">utils.download_trailers(trailers, item_metadata)</span>

<span class="sd"># Checking available disk space before download</span>
<span class="sd">download_path = &quot;/path/to/download/trailers&quot;</span>
<span class="sd">has_enough_space = utils.check_space(download_path)</span>

<span class="sd">if not has_enough_space:</span>
<span class="sd">    print(&quot;Insufficient disk space. Unable to download trailers.&quot;)</span>

<span class="sd"># Example usage to perform post-processing on downloaded trailers</span>
<span class="sd">cache_path = &quot;/path/to/cache/trailers&quot;</span>
<span class="sd">downloaded_files = [&quot;trailer1.mp4&quot;, &quot;trailer2.mp4&quot;, &quot;trailer3.mp4&quot;]</span>
<span class="sd">utils.post_process(cache_path, downloaded_files, item_metadata)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">from</span> <span class="nn">modules.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">modules.youtube_dl</span> <span class="kn">import</span> <span class="n">YoutubeDL</span>

<span class="c1"># Disable SSL warnings</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<div class="viewcode-block" id="Utils">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils">[docs]</a>
<span class="k">class</span> <span class="nc">Utils</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Utils class with a logger and configuration.</span>

<span class="sd">        :param logger: Logger instance for logging messages</span>
<span class="sd">        :param config: Configuration dictionary or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yt_downloader</span> <span class="o">=</span> <span class="n">YoutubeDL</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="Utils.replace_slash_backslash">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.replace_slash_backslash">[docs]</a>
    <span class="k">def</span> <span class="nf">replace_slash_backslash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace forward slashes and backward slashes with spaces.</span>
<span class="sd">        Replace multiple spaces with a single space.</span>

<span class="sd">        :param text: Input text containing slashes</span>
<span class="sd">        :return: Text with replaced slashes and spaces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[</span><span class="se">\\</span><span class="s2">/]+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="Utils.get_title">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.get_title">[docs]</a>
    <span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the title of an item from its metadata.</span>

<span class="sd">        :param item: Metadata dictionary of the item</span>
<span class="sd">        :return: Title of the item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using self.config.get with a default value</span>
        <span class="n">title_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APP_USE_TITLE&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>

        <span class="c1"># Check if title_key contains &quot;title&quot; (case insensitive)</span>
        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">in</span> <span class="n">title_key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title_key</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">title</span></div>


<div class="viewcode-block" id="Utils.trailer_pull">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.trailer_pull">[docs]</a>
    <span class="k">def</span> <span class="nf">trailer_pull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmdb_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">item_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seasonNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve trailer information from TMDB API.</span>

<span class="sd">        :param tmdb_id: TMDB ID of the movie or TV show</span>
<span class="sd">        :param item_type: Type of item (&#39;movie&#39; or &#39;tv&#39;)</span>
<span class="sd">        :param parent_mode: Flag for parent mode retrieval (TV)</span>
<span class="sd">        :return: List of cleaned trailer information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Log the process of getting trailer information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> -&gt; GET&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Getting information about </span><span class="si">{</span><span class="n">tmdb_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">item_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">tmdb_id</span><span class="o">=</span><span class="n">tmdb_id</span><span class="p">,</span>
            <span class="n">item_type</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">base_link</span> <span class="o">=</span> <span class="s2">&quot;api.themoviedb.org/3&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;TMDB_API_KEY&quot;</span><span class="p">]</span>

        <span class="c1"># Construct the URL for TMDB API based on item type and TMDB ID</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">base_link</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">item_type</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tmdb_id</span><span class="si">}</span><span class="s2">/videos&quot;</span>
        <span class="k">if</span> <span class="n">seasonNumber</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">base_link</span><span class="si">}</span><span class="s2">/tv/</span><span class="si">{</span><span class="n">tmdb_id</span><span class="si">}</span><span class="s2">/season/</span><span class="si">{</span><span class="n">seasonNumber</span><span class="si">}</span><span class="s2">/videos&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>

        <span class="c1"># Make a GET request to TMDB API</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
                <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;TMDB_LANGUAGE_TRAILER&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
            <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Process the response from TMDB API</span>
        <span class="k">if</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="n">raw_trailers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_trailers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

            <span class="n">trailers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Extract relevant trailer information from the API response</span>
            <span class="k">for</span> <span class="n">trailer</span> <span class="ow">in</span> <span class="n">raw_trailers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="c1"># Check if the trailer meets the specified conditions</span>
                <span class="n">should_add_trailer</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Verify each condition only if it is present in the configuration</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_OFFICIAL&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">should_add_trailer</span> <span class="o">=</span> <span class="n">should_add_trailer</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trailer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;official&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_OFFICIAL&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_TYPE_ITEM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">should_add_trailer</span> <span class="o">=</span> <span class="n">should_add_trailer</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trailer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_TYPE_ITEM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_SIZE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">should_add_trailer</span> <span class="o">=</span> <span class="n">should_add_trailer</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trailer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_SIZE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_SOURCE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">should_add_trailer</span> <span class="o">=</span> <span class="n">should_add_trailer</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trailer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMDB_SOURCE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="c1"># If all specified conditions are met, process the trailer</span>
                <span class="k">if</span> <span class="n">should_add_trailer</span><span class="p">:</span>
                    <span class="c1"># Construct the YouTube link for the trailer using the base link</span>
                    <span class="c1"># from the config and the trailer&#39;s key.</span>
                    <span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;yt_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;YT_DLP_BASE_URL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                    <span class="c1"># Replace any backslashes or forward slashes in the trailer&#39;s name.</span>
                    <span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_slash_backslash</span><span class="p">(</span><span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="c1"># Parse the &#39;published_at&#39; string to a datetime object with UTC timezone.</span>
                    <span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;published_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">trailer</span><span class="p">[</span><span class="s2">&quot;published_at&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="c1"># Add the trailer to the list of trailers.</span>
                    <span class="n">trailers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trailer</span><span class="p">)</span>

            <span class="c1"># Sort the list based on the proximity to the current datetime</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APP_ONLY_ONE_TRAILER&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">trailers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">trailers</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;published_at&quot;</span><span class="p">]),</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">trailers</span>

        <span class="c1"># Handle warnings if the response status code is not in the 200-300 range</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No message&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[ TMDB ]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{msg_gen}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg_gen</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Utils.post_process">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.post_process">[docs]</a>
    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform post-processing on downloaded trailers using FFMPEG.</span>

<span class="sd">        :param cache_path: Path to the cache directory containing trailers</span>
<span class="sd">        :param files: List of downloaded trailer filenames</span>
<span class="sd">        :param item: Metadata of the item (movie or TV show)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trailers_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;trailers&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">trailers_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ffmpeg_cmd_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FFMPEG_COMMAND_TEMPLATE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ffmpeg_cmd_template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;FFMPEG Command template is not defined in config.yaml&quot;</span><span class="p">)</span>

        <span class="c1"># Iterate through each downloaded file and perform FFMPEG processing</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FFMPEG_FILE_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;mkv&quot;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="n">ffmpeg_cmd_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">thread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FFMPEG_THREAD_COUNT&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FFMPEG_BUFFER_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;1M&quot;</span><span class="p">),</span>
                <span class="n">path_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;outputs_folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Log the FFMPEG command used for processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> -&gt; FFMPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{msg_gen}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg_gen</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>

            <span class="n">subprocess_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APP_QUIET_MODE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">subprocess_args</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span>
                <span class="n">subprocess_args</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span>
                <span class="n">subprocess_args</span><span class="p">[</span><span class="s2">&quot;stdin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span>

            <span class="c1"># Execute the FFMPEG command with subprocess</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">**</span><span class="n">subprocess_args</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Always remove the cache_path after FFMPEG execution</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.download_trailers">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.download_trailers">[docs]</a>
    <span class="k">def</span> <span class="nf">download_trailers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download trailers from YouTube using YoutubeDL.</span>

<span class="sd">        :param links: List of YouTube trailer links</span>
<span class="sd">        :param item: Metadata of the item (movie or TV show)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yt_downloader</span><span class="o">.</span><span class="n">download_trailers</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="c1"># Perform post-processing on downloaded files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_title</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> -&gt; DOWNLOAD&quot;</span><span class="p">,</span> <span class="s2">&quot;No trailers were downloaded using TMDB API.&quot;</span><span class="p">)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_slash_backslash</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;yt_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ytsearch5:</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;use_title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;YT_DLP_SEARCH_KEYWORD&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">arr_id_trailer</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;youTubeTrailerId&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arr_id_trailer</span><span class="p">:</span>
                    <span class="n">link</span><span class="p">[</span><span class="s2">&quot;yt_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;YT_DLP_BASE_URL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr_id_trailer</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> -&gt; DOWNLOAD&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Try to download using </span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;yt_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yt_downloader</span><span class="o">.</span><span class="n">download_trailers</span><span class="p">([</span><span class="n">link</span><span class="p">],</span> <span class="n">item</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.check_space">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.check_space">[docs]</a>
    <span class="k">def</span> <span class="nf">check_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check available disk space to ensure there is enough space to download and process trailers.</span>

<span class="sd">        :param path: Path where trailers will be downloaded</span>
<span class="sd">        :return: Boolean indicating if there is enough space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disk</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Convert GB to bytes</span>
        <span class="n">min_free_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MIN_FREE_SPACE&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disk</span><span class="o">.</span><span class="n">free</span> <span class="o">&gt;</span> <span class="n">min_free_space</span></div>


<div class="viewcode-block" id="Utils.get_new_trailers">
<a class="viewcode-back" href="../../modules/utils.html#modules.utils.Utils.get_new_trailers">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_trailers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trailer_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">existing_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trailer names that do not already exist in the specified folder.</span>

<span class="sd">        :param trailer_names: List of trailer names to check</span>
<span class="sd">        :param existing_files: Files existing</span>
<span class="sd">        :return: List of trailer names that do not already exist in the folder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">existing_files</span><span class="p">]</span>

        <span class="n">new_trailers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">trailer_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_names</span><span class="p">:</span>
                <span class="n">new_trailers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_trailers</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Trailer Finder</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/logger.html">Logger Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/radarr.html">radarr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/sonarr.html">sonarr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/translator.html">translator module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/utils.html">utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/youtube_dl.html">youtube_dl module</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Kalibrado.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>